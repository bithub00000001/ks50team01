<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ksmart.ks50team01.platform.trip.mapper.PTourApiMapper">

    <resultMap id="areaMap" type="pTourApi">
        <id     column="area_code" property="areaCode"/>
        <result column="areaNum"   property="areaNum"/>
        <result column="area_name" property="areaName"/>
        <result column="areaRegDate"   property="areaRegDate"/>
        <result column="areaModDate" property="areaModDate"/>


    </resultMap>

    <resultMap id="sigunMap" type="pTourApi">
        <id     column="sigungu_id" property="sigunguId"/>
        <result column="sigungu_code" property="sigunguCode"/>
        <result column="sigungu_name" property="sigunguName"/>
        <result column="sigunNum"     property="sigunNum"/>
        <result column="sigunRegDate" property="sigunRegDate"/>
        <result column="sigunModDate" property="sigunModDate"/>

        <association property="areaInfo" javaType="pTourApi">
            <id     column="area_code" property="areaCode"/>
            <result column="areaNum"   property="areaNum"/>
            <result column="area_name" property="areaName"/>
            <result column="areaRegDate"   property="areaRegDate"/>
            <result column="areaModDate" property="areaModDate"/>
        </association>
    </resultMap>

    <insert id="upsertAreaCode" parameterType="pTourApi">
        /* 지역 코드 업서트 */
        INSERT INTO
            AREA_CODE (
                        area_code,
                        area_name,
                        REG_YMD
                        )
        VALUES
            (
            #{areaCode},
            #{areaName},
            now()
            )
        ON DUPLICATE KEY
            UPDATE
                area_name = #{areaName},
                MDFCN_YMD = now();
    </insert>

    <insert id="upsertSigunguCode" parameterType="pTourApi">
        /* 시군구 코드 업서트 */
        INSERT INTO
            SIGUNGU_CODE
            (
             sigungu_code,
             sigungu_name,
             area_id,
             REG_YMD
            )
        VALUES
            (
            #{sigunguCode},
            #{sigunguName},
            (
                SELECT
                    AREA_CODE.area_code
                FROM
                    AREA_CODE
                WHERE
                    AREA_CODE.area_code = #{areaCode}
                ),
            now()
            )
        ON DUPLICATE KEY
            UPDATE
                sigungu_name = #{sigunguName},
                MDFCN_YMD = now();
    </insert>

    <select id="getAreaCodeList" resultMap="areaMap">
        /* 전체 지역 코드 조회 */
        SELECT
            row_number() over (order by area_code) as areaNum,
            area_code,
            area_name,
            REG_YMD as areaRegDate,
            MDFCN_YMD as areaModDate
        FROM
            AREA_CODE
    </select>

    <select id="getSigunList" resultMap="sigunMap">
        /* 전체 시군 코드 조회 */
        SELECT
            row_number() over (order by AC.area_code, SC.sigungu_code) as sigunNum,
            SC.sigungu_code,
            SC.sigungu_name,
            SC.area_id,
            AC.area_code,
            AC.area_name,
            SC.REG_YMD as sigunRegDate,
            SC.MDFCN_YMD as sigunModDate
        FROM
            SIGUNGU_CODE as SC
            left join
            AREA_CODE as AC
            on
            SC.area_id = AC.area_code
    </select>
</mapper>
